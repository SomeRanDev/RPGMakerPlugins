/*:
 * @plugindesc Adds blinking animation to your Actors in the dialogue boxes.
 * @author SumRndmDde
 *
 * @param Use Default Blinking
 * @desc If set to 'true', all faces without explicit blinking animation set will use default blinking animation.
 * @default false
 *
 * @param = Default Values =
 * @default
 *
 * @param Cycle Length
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default 150
 *
 * @param Blink Length
 * @desc The amount of time (in frames) a blink lasts.
 * @default 10
 *
 * @param Blink Times
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default 10, 30
 *
 * @param = \Blink[1] Values =
 * @default
 *
 * @param Cycle Length 1
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 1
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 1
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[2] Values =
 * @default
 *
 * @param Cycle Length 2
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 2
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 2
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[3] Values =
 * @default
 *
 * @param Cycle Length 3
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 3
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 3
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[4] Values =
 * @default
 *
 * @param Cycle Length 4
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 4
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 4
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[5] Values =
 * @default
 *
 * @param Cycle Length 5
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 5
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 5
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[6] Values =
 * @default
 *
 * @param Cycle Length 6
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 6
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 6
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[7] Values =
 * @default
 *
 * @param Cycle Length 7
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 7
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 7
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[8] Values =
 * @default
 *
 * @param Cycle Length 8
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 8
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 8
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[9] Values =
 * @default
 *
 * @param Cycle Length 9
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 9
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 9
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[10] Values =
 * @default
 *
 * @param Cycle Length 10
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 10
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 10
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[11] Values =
 * @default
 *
 * @param Cycle Length 11
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 11
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 11
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[12] Values =
 * @default
 *
 * @param Cycle Length 12
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 12
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 12
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[13] Values =
 * @default
 *
 * @param Cycle Length 13
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 13
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 13
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[14] Values =
 * @default
 *
 * @param Cycle Length 14
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 14
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 14
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[15] Values =
 * @default
 *
 * @param Cycle Length 15
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 15
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 15
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[16] Values =
 * @default
 *
 * @param Cycle Length 16
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 16
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 16
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[17] Values =
 * @default
 *
 * @param Cycle Length 17
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 17
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 17
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[18] Values =
 * @default
 *
 * @param Cycle Length 18
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 18
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 18
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[19] Values =
 * @default
 *
 * @param Cycle Length 19
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 19
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 19
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[20] Values =
 * @default
 *
 * @param Cycle Length 20
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 20
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 20
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[21] Values =
 * @default
 *
 * @param Cycle Length 21
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 21
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 21
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[22] Values =
 * @default
 *
 * @param Cycle Length 22
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 22
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 22
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[23] Values =
 * @default
 *
 * @param Cycle Length 23
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 23
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 23
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[24] Values =
 * @default
 *
 * @param Cycle Length 24
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 24
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 24
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[25] Values =
 * @default
 *
 * @param Cycle Length 25
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 25
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 25
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[26] Values =
 * @default
 *
 * @param Cycle Length 26
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 26
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 26
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[27] Values =
 * @default
 *
 * @param Cycle Length 27
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 27
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 27
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[28] Values =
 * @default
 *
 * @param Cycle Length 28
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 28
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 28
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[29] Values =
 * @default
 *
 * @param Cycle Length 29
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 29
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 29
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @param = \Blink[30] Values =
 * @default
 *
 * @param Cycle Length 30
 * @desc The length (in frames) that the blinking animation cycles through.
 * @default
 *
 * @param Blink Length 30
 * @desc The amount of time (in frames) a blink lasts.
 * @default
 *
 * @param Blink Times 30
 * @desc The times throughout the cycle in which the face blinks. Use commas to seperate multiple times in a cycle.
 * @default
 *
 * @help
 *
 *
 * Blinking Faces
 * Version 1.00
 * SumRndmDde
 *
 *
 * This Plugin allows you to add a "blinking" animation to the face images
 * inside the dialogue box.
 *
 *
 * ==========================================================================
 *  Setting up Files
 * ==========================================================================
 *
 * The face images are stored in: /img/faces/
 *
 * Each image holds 8 faces.
 *
 * In order to add faces for the "blinking" animation, create "copies" of 
 * the faces with their eyes closed, then create another file with the
 * same file name, only with "-blinking" added to it.
 *
 * So for example, Harold is in the Actor1.png file and is in the top-left
 * of the file.
 *
 * If you wanted to give him his blinking animation, you'd create a file
 * within the /img/faces/ folder called "Actor1-blinking.png".
 * Make sure it is the same size of the Actor1.png image and the Harold
 * face is in the same spot as he was in the original image.
 *
 * So pretty much, if you wanted to give blinking animations to every
 * face in Actor1.png, then you would have all the same images, only with
 * their eyes closed, and put them in Actor1-blinking.png
 *
 *
 * ==========================================================================
 *  How to Set up Blinking
 * ==========================================================================
 *
 * There are three things required for setting up the blinking animation:
 *
 * Cycle Length - The length of one blinking animation cycle
 *
 * Blink Length - The amount of frames in which a face's eyes are closed
 *  during a blink.
 *
 * Blink Times - The frames in the a face blinks. For example, if "30" is
 *  inputted, then the face will blink at frame 30 of each blinking
 *  cycle. You can have multiple blinking times, just seperate each one 
 *  with a comma, for example:
 *                      30, 50, 90, 120
 *
 *
 * You can set up these options for your blinking animation in the
 * Parameters.
 *
 *
 * ==========================================================================
 *  How to Start Blinking in Dialogue Box
 * ==========================================================================
 *
 * Within any "Show Text" event, use the escape code: \Blink[x]
 *
 * Set 'x' to the blinking animation you wish to use.
 * You can customize the blinking animations in the Parameters.
 *
 * If "Use Default Blinking" is set to false, and this escape code is not
 * used, then no blinking animation will occur.
 *
 * If "Use Default Blinking" is set to true, and this escape code is not
 * used, then the default blinking animation will be used.
 *
 *
 * ==========================================================================
 *  End of Help File
 * ==========================================================================
 * 
 * Welcome to the bottom of the Help file.
 *
 *
 * Thanks for reading!
 * If you have questions, or if you enjoyed this Plugin, please check
 * out my YouTube channel!
 *
 * https://www.youtube.com/c/SumRndmDde
 *
 *
 * Until next time,
 *   ~ SumRndmDde
 */

var SRD = SRD || {};
SRD.BlinkingFaces = SRD.BlinkingFaces || {};

var Imported = Imported || {};
Imported["SumRndmDde Blinking Faces"] = true;

(function(_) {

	"use strict";

	_.default = String(PluginManager.parameters('SRD_BlinkingFaces')['Use Default Blinking']).trim().toLowerCase() === 'true';

	_.cycle = [];
	_.length = [];
	_.times = [];
	_.timesOn = [];
	_.cycle[0] = parseInt(PluginManager.parameters('SRD_BlinkingFaces')['Cycle Length']);
	_.length[0] = parseInt(PluginManager.parameters('SRD_BlinkingFaces')['Blink Length']);
	_.times[0] = String(PluginManager.parameters('SRD_BlinkingFaces')['Blink Times']).split(/\s*,\s*/);
	_.timesOn[0] = [];
	for(var i = 0; i < _.times[0].length; i++) {
		_.times[0][i] = parseInt(_.times[0][i]);
		_.timesOn[0][i] = parseInt(_.times[0][i] + _.length[0]);
	}

	for(var i = 1; i <= 30; i++) {
		_.cycle[i] = parseInt(PluginManager.parameters('SRD_BlinkingFaces')['Cycle Length ' + i]);
		_.length[i] = parseInt(PluginManager.parameters('SRD_BlinkingFaces')['Blink Length ' + i]);
		_.times[i] = String(PluginManager.parameters('SRD_BlinkingFaces')['Blink Times ' + i]).split(/\s*,\s*/);
		_.timesOn[i] = [];
		for(var j = 0; j < _.times[i].length; j++) {
			_.times[i][j] = parseInt(_.times[i][j]);
			_.timesOn[i][j] = parseInt(_.times[i][j] + _.length[i]);
		}
	}

	_.findEscapeCharacters = function(text) {
		var info = text.match(/\\Blink\[(\d+)\]/im);
		if(!info) return 0;
		return parseInt(info[1]);
	};

	var _Game_Message_clear = Game_Message.prototype.clear;
	Game_Message.prototype.clear = function() {
	    _Game_Message_clear.call(this);
	    this._isBlinkingAnimation = false;
	};

	var _Game_Message_faceName = Game_Message.prototype.faceName;
	Game_Message.prototype.faceName = function() {
	    var temp = _Game_Message_faceName.call(this);
	    if(this._isBlinkingAnimation) temp += '-blinking';
	    return temp;
	};

	Game_Message.prototype.setBlinkingAnimation = function(boolean) {
		this._isBlinkingAnimation = boolean;
	};

	Game_Message.prototype.getBlinkingAnimation = function() {
		return this._isBlinkingAnimation;
	};

	var _Window_Base_convertEscapeCharacters = Window_Base.prototype.convertEscapeCharacters;
	Window_Base.prototype.convertEscapeCharacters = function(text) {
	    var temp = _Window_Base_convertEscapeCharacters.call(this, text);
	    temp = temp.replace(/\x1bBlink\[\d+\]/gi, '');
	    return temp;
	};

	var _Window_Message_update = Window_Message.prototype.update;
	Window_Message.prototype.update = function() {
		if(!this.isOpening() && !this.isClosing() && $gameMessage.faceName().length > 0 && $gameMessage.allText()) {
			var index = _.findEscapeCharacters($gameMessage.allText());
			if(_.default || index > 0) {
			    var blinkCount = this._animationCount % _.cycle[index];
			    for(var i = 0; i < _.times[index].length; i++) {
			    	if(blinkCount === _.times[index][i]) {
			    		this.contents.clearRect(0, 0, this._faceWidth, this._faceHeight);
			    		$gameMessage.setBlinkingAnimation(true);
			    		this.drawMessageFace();
			    		$gameMessage.setBlinkingAnimation(false);
			    	} else if(blinkCount === _.timesOn[index][i]) {
			    		this.contents.clearRect(0, 0, this._faceWidth, this._faceHeight);
			    		this.drawMessageFace();
			    	}
			    }
			}
		}
	    _Window_Message_update.call(this);
	};

})(SRD.BlinkingFaces);